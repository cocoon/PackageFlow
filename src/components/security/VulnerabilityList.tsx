/**
 * Vulnerability List Component
 * Displays a filterable, searchable list of vulnerabilities
 * @see specs/005-package-security-audit/spec.md
 */

import { useState, useMemo, useCallback } from 'react';
import { Search, Filter, X, Package, AlertCircle } from 'lucide-react';
import type { VulnItem, VulnSeverity, SeverityFilterState } from '../../types/security';
import { VulnerabilityCard } from './VulnerabilityDetail';
import { SeverityBadge } from './SeverityBadge';
import { cn } from '../../lib/utils';

interface VulnerabilityListProps {
  /** List of vulnerabilities to display */
  vulnerabilities: VulnItem[];
  /** Additional CSS classes */
  className?: string;
}

/** Default filter state - all severities visible */
const defaultFilterState: SeverityFilterState = {
  critical: true,
  high: true,
  moderate: true,
  low: true,
  info: true,
};

/** Severity order for sorting */
const severityOrder: Record<VulnSeverity, number> = {
  critical: 0,
  high: 1,
  moderate: 2,
  low: 3,
  info: 4,
};

/**
 * Filterable and searchable vulnerability list
 */
export function VulnerabilityList({
  vulnerabilities,
  className,
}: VulnerabilityListProps) {
  // State
  const [searchQuery, setSearchQuery] = useState('');
  const [severityFilter, setSeverityFilter] = useState<SeverityFilterState>(defaultFilterState);
  const [showFilterPanel, setShowFilterPanel] = useState(false);
  const [expandedIds, setExpandedIds] = useState<Set<string>>(new Set());

  // Calculate severity counts
  const severityCounts = useMemo(() => {
    return vulnerabilities.reduce(
      (acc, vuln) => {
        acc[vuln.severity]++;
        return acc;
      },
      { critical: 0, high: 0, moderate: 0, low: 0, info: 0 } as Record<VulnSeverity, number>
    );
  }, [vulnerabilities]);

  // Filter and sort vulnerabilities
  const filteredVulnerabilities = useMemo(() => {
    return vulnerabilities
      .filter((vuln) => {
        // Severity filter
        if (!severityFilter[vuln.severity]) return false;

        // Search filter
        if (searchQuery.trim()) {
          const query = searchQuery.toLowerCase();
          return (
            vuln.packageName.toLowerCase().includes(query) ||
            vuln.title.toLowerCase().includes(query) ||
            vuln.id.toLowerCase().includes(query) ||
            vuln.cves.some((cve) => cve.toLowerCase().includes(query))
          );
        }

        return true;
      })
      .sort((a, b) => {
        // Sort by severity (critical first)
        const severityDiff = severityOrder[a.severity] - severityOrder[b.severity];
        if (severityDiff !== 0) return severityDiff;

        // Then by direct dependency status
        if (a.isDirect !== b.isDirect) return a.isDirect ? -1 : 1;

        // Then alphabetically by package name
        return a.packageName.localeCompare(b.packageName);
      });
  }, [vulnerabilities, severityFilter, searchQuery]);

  // Toggle severity filter
  const toggleSeverity = useCallback((severity: VulnSeverity) => {
    setSeverityFilter((prev) => ({
      ...prev,
      [severity]: !prev[severity],
    }));
  }, []);

  // Reset filters
  const resetFilters = useCallback(() => {
    setSearchQuery('');
    setSeverityFilter(defaultFilterState);
  }, []);

  // Toggle expand
  const toggleExpand = useCallback((id: string) => {
    setExpandedIds((prev) => {
      const next = new Set(prev);
      if (next.has(id)) {
        next.delete(id);
      } else {
        next.add(id);
      }
      return next;
    });
  }, []);

  // Expand all / Collapse all
  const expandAll = useCallback(() => {
    setExpandedIds(new Set(filteredVulnerabilities.map((v) => v.id)));
  }, [filteredVulnerabilities]);

  const collapseAll = useCallback(() => {
    setExpandedIds(new Set());
  }, []);

  // Check if any filter is active
  const hasActiveFilter =
    searchQuery.trim() !== '' ||
    Object.values(severityFilter).some((v) => !v);

  // Empty state
  if (vulnerabilities.length === 0) {
    return (
      <div className={cn('flex flex-col items-center justify-center py-12 text-center', className)}>
        <div className="p-4 bg-green-500/10 rounded-full mb-4">
          <Package className="w-8 h-8 text-green-400" aria-hidden="true" />
        </div>
        <h3 className="text-lg font-medium text-foreground mb-2">No Vulnerabilities Found</h3>
        <p className="text-sm text-muted-foreground max-w-sm">
          Your project dependencies are secure. Keep your packages updated to maintain security.
        </p>
      </div>
    );
  }

  return (
    <div className={cn('space-y-4', className)}>
      {/* Search, Filter, and Controls Bar */}
      <div className="flex items-center gap-2">
        {/* Search Input */}
        <div className="relative flex-1">
          <Search
            className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"
            aria-hidden="true"
          />
          <input
            type="text"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            placeholder="Search by package, title, or CVE..."
            autoComplete="off"
            autoCorrect="off"
            autoCapitalize="off"
            spellCheck={false}
            className={cn(
              'w-full pl-9 pr-8 py-2',
              'bg-secondary border border-border rounded-lg',
              'text-sm text-foreground placeholder-muted-foreground',
              'focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500/30'
            )}
            aria-label="Search vulnerabilities"
          />
          {searchQuery && (
            <button
              onClick={() => setSearchQuery('')}
              className="absolute right-2 top-1/2 -translate-y-1/2 p-1 text-muted-foreground hover:text-foreground"
              aria-label="Clear search"
            >
              <X className="w-4 h-4" />
            </button>
          )}
        </div>

        {/* Filter Toggle Button */}
        <button
          onClick={() => setShowFilterPanel(!showFilterPanel)}
          className={cn(
            'flex items-center gap-1.5 px-3 py-2',
            'border rounded-lg text-sm transition-colors',
            showFilterPanel || hasActiveFilter
              ? 'bg-blue-500/20 border-blue-500/50 text-blue-400'
              : 'bg-secondary border-border text-muted-foreground hover:text-foreground'
          )}
          aria-expanded={showFilterPanel}
          aria-controls="filter-panel"
        >
          <Filter className="w-4 h-4" aria-hidden="true" />
          <span>Filter</span>
        </button>

        {/* Reset Filters */}
        {hasActiveFilter && (
          <button
            onClick={resetFilters}
            className="px-3 py-2 text-sm text-muted-foreground hover:text-foreground transition-colors"
          >
            Reset
          </button>
        )}

        {/* Shown Count */}
        <span className="text-sm text-muted-foreground whitespace-nowrap">
          {filteredVulnerabilities.length} of {vulnerabilities.length}
        </span>

        {/* Expand/Collapse Controls */}
        <div className="flex items-center gap-1 text-sm border-l border-border pl-2 ml-1">
          <button
            onClick={expandAll}
            className="text-muted-foreground hover:text-foreground transition-colors whitespace-nowrap"
            disabled={filteredVulnerabilities.length === 0}
          >
            Expand
          </button>
          <span className="text-muted-foreground">|</span>
          <button
            onClick={collapseAll}
            className="text-muted-foreground hover:text-foreground transition-colors whitespace-nowrap"
            disabled={expandedIds.size === 0}
          >
            Collapse
          </button>
        </div>
      </div>

      {/* Filter Panel */}
      {showFilterPanel && (
        <div
          id="filter-panel"
          className="p-3 bg-card border border-border rounded-lg"
        >
          <h4 className="text-sm font-medium text-foreground mb-3">Filter by Severity</h4>
          <div className="flex flex-wrap gap-2">
            {(['critical', 'high', 'moderate', 'low', 'info'] as VulnSeverity[]).map((severity) => (
              <button
                key={severity}
                onClick={() => toggleSeverity(severity)}
                className={cn(
                  'transition-opacity',
                  !severityFilter[severity] && 'opacity-40'
                )}
                aria-pressed={severityFilter[severity]}
              >
                <SeverityBadge
                  severity={severity}
                  count={severityCounts[severity]}
                  showIcon
                />
              </button>
            ))}
          </div>
        </div>
      )}

      {/* Vulnerability Cards */}
      {filteredVulnerabilities.length > 0 ? (
        <div className="space-y-2" role="list" aria-label="Vulnerability list">
          {filteredVulnerabilities.map((vuln) => (
            <VulnerabilityCard
              key={vuln.id}
              vulnerability={vuln}
              isExpanded={expandedIds.has(vuln.id)}
              onToggleExpand={() => toggleExpand(vuln.id)}
            />
          ))}
        </div>
      ) : (
        <div className="flex flex-col items-center justify-center py-8 text-center">
          <AlertCircle className="w-8 h-8 text-muted-foreground mb-3" aria-hidden="true" />
          <h3 className="text-base font-medium text-foreground mb-1">No Matching Vulnerabilities</h3>
          <p className="text-sm text-muted-foreground">
            Try adjusting your search query or filters
          </p>
          <button
            onClick={resetFilters}
            className="mt-3 text-sm text-blue-400 hover:text-blue-300"
          >
            Clear all filters
          </button>
        </div>
      )}
    </div>
  );
}

/**
 * Compact vulnerability list for overview displays
 */
interface CompactVulnerabilityListProps {
  vulnerabilities: VulnItem[];
  maxItems?: number;
  onViewAll?: () => void;
  className?: string;
}

export function CompactVulnerabilityList({
  vulnerabilities,
  maxItems = 5,
  onViewAll,
  className,
}: CompactVulnerabilityListProps) {
  // Sort by severity and take top items
  const topVulnerabilities = useMemo(() => {
    return [...vulnerabilities]
      .sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity])
      .slice(0, maxItems);
  }, [vulnerabilities, maxItems]);

  if (vulnerabilities.length === 0) {
    return (
      <div className={cn('text-sm text-muted-foreground text-center py-4', className)}>
        No vulnerabilities found
      </div>
    );
  }

  return (
    <div className={cn('space-y-2', className)}>
      {topVulnerabilities.map((vuln) => (
        <div
          key={vuln.id}
          className="flex items-center gap-2 p-2 bg-muted rounded"
        >
          <SeverityBadge severity={vuln.severity} compact showIcon={false} />
          <div className="flex-1 min-w-0">
            <p className="text-sm text-foreground truncate">{vuln.title}</p>
            <p className="text-xs text-muted-foreground font-mono truncate">
              {vuln.packageName}@{vuln.installedVersion}
            </p>
          </div>
        </div>
      ))}
      {vulnerabilities.length > maxItems && onViewAll && (
        <button
          onClick={onViewAll}
          className="w-full py-2 text-sm text-blue-400 hover:text-blue-300 text-center"
        >
          View all {vulnerabilities.length} vulnerabilities
        </button>
      )}
    </div>
  );
}
